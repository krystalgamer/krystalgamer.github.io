<html>

	<head>
		
	<link rel="stylesheet" href="../static/borland.css">

		<link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
		<link rel="stylesheet" href="../static/styles.css" >
		<meta name="viewport" content="width=device-width, initial-scale=1">
		

	</head>


	<body>

		<header>
			<div class="nav-holder">
				<nav class="container">
				<div class="logo-name">
					<img class="logo" src="https://krystalgamer.github.io/images/logo.png" alt="krystalgamer's Lair">
					<a href="../index.html">krystalgamer's Lair</a>
				</div>
				<a href="../about/index.html">About</a>
				</nav>
			</div>


			<div class="header-bg">
			
				<h1>
					krystalgamer - Blog
				</h1>

			</div>
		</header>
		<main class="container dope-shadow">

			
	<div class="post-holder">
		<p><h1>Reversing: Spiderman 2000 - PKR file format</h1></p>
<h1>What is it?</h1>
<p>It's a container format used to store all the game's files. It was developed by Neversoft and is most known for its use on &quot;Tony Hawk Pro Skater&quot; game series.
Since it contains all game files in order to modify anything we need to know what is going on.</p>
<h1>Structure</h1>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">magic</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">dirOffset</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="n">PKR3File</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>The files start with a magic number <code>PKR3</code> followed by an offset to the directory tree header.</p>
<p><img src="../static/images/spidey/pkr_header.png" alt="PKR Header" /></p>
<p>As you can see after the offset there are the words <code>RIFF</code> and <code>WAVE</code> which are also magic numbers of <a href="http://soundfile.sapp.org/doc/WaveFormat/">WAV files</a>. Due to the fact that <code>spidey.exe</code> contains a lot of file names this mislead me. Initally I thought this files had no structure and were just a bunch of files merged together. Thankfully there are a lot of references in the code to the functions responsible to handle PKR files.</p>
<p><img src="../static/images/spidey/pkr_strings.png" alt="PKR references" /> </p>
<h2>Dir structure</h2>
<h2>The header</h2>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">unk</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">numDirs</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">numFiles</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="n">PKRDirHeader</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p><em>Quick note: You'll see a lot of variables/members called <code>unk</code> due to the fact that I have no ideia of what they do and their modification not having any sign of impact on the file interpretation and not existing any references to it in the cose.</em></p>
<p>It contains the number of directories and the <strong>total</strong> number of files that the PKR holds.</p>
<h2>The body</h2>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">unk</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">numFiles</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="n">PKRDir</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>After the header there's an array of PKRDirs(its lenght is defined by <code>numDirs</code>). And right after this there's a PKRFile array with the lenght of the total number of files.</p>
<div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">total</span><span class="p">[</span><span class="mh">0x34</span><span class="p">];</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">crc</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">compressed</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">fileOffset</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">uncompressedSize</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">compressedSize</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">};</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="n">PKRFile</span><span class="p">;</span><span class="w"></span>
</pre></div>
<p>As you can see the game files have integrity checks, in this case it's actually <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC</a>.</p>
<p><code>compressed</code> can either hold 2(0x00000002) or -2(0xFFFFFFFE) which mean compressed and uncompressed respectively.</p>
<p><code>fileOffset</code> contains the offset to file in the PKR file <strong>counting from the start</strong>.</p>
<p><code>compressedSize</code> holds the size of the compressed files.</p>
<p><code>uncompressedSize</code> holds the size of the uncompressed files <strong>OR</strong> the size of a compressed file when decompressed.</p>
<p>Here's how all these structures look in the file:</p>
<p><img src="../static/images/spidey/pkr_inside.png" alt="PKR structure" /></p>
<h3>Green is the PKRDirHeader, red the PKRDirs and blue the PKRFiles.</h3>
<h2>Compression method</h2>
<p>The files are compressed using zlib. Finding it was a piece of cake, again there are <strong>a lot</strong> of references in the strings.</p>
<p>Implementing it was the hardest part, during this period I got so many crashes that I decided to simply go with uncompress(). I know it sucks because it wastes a lot of cpu power but hey, it works ¯\_(ツ)_/¯.</p>
<p>If you're interested in reading my implementation you can <a href="https://github.com/krystalgamer/spidey-tools/tree/master/pkr_extractor">checkout my github</a>.</p>

	</div>


		</main>

		<footer class="container">
			© 2022 krystalgamer
		</footer>
	</body>

</html>