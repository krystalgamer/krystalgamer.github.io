<html>

	<head>
		<title> Reversing: Spiderman 2000 - Breaking CD-ROM protection </title>
		
	<link rel="stylesheet" href="../static/borland.css">

		<link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
		<link rel="stylesheet" href="../static/styles.css" >
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" type="application/atom+xml" href="../feed.xml">

		
			<meta property="og:title" content=" Reversing: Spiderman 2000 - Breaking CD-ROM protection " />
			<meta property="og:description" content="With the closing of the isozone, and missing the link of the available NO-CD patch I needed to crack it myself" />
			<meta property="og:type" content="summary" />
			<meta name="og:image" content="https://krystalgamer.github.io/static/banner.jpg" />

		
	</head>


	<body>

		<header>
			<div class="nav-holder">
				<nav class="container">
				<div class="logo-name">
					<img class="logo" src="../static/logo.png" alt="krystalgamer's Lair">
					<a href="../index.html">krystalgamer's Lair</a>
				</div>
				<a href="../about/index.html">About</a>
				</nav>
			</div>


			<div class="header-bg" style="background-image: url(../static/banner.jpg)">
			
				<h1>
					krystalgamer - Blog
				</h1>

			</div>
		</header>
		<main class="container dope-shadow">

			
	<div class="post-holder">
		<p><h1 id="post-title">Reversing: Spiderman 2000 - Breaking CD-ROM protection</h1></p>
<h1>Prologue</h1>
<p>Spiderman was acting wonky with DxWnd after a long time working just fine (it happened to me before but it magically got solved, I think it might be Win10 related since the Win7 VM works perfectly). Not knowing the causes I decided to delete the game and reinstall it. Here comes the fuck up, I had my idb in the game folder. I wasn't able to recover it.</p>
<p>Now I had an uncracked game.</p>
<h1>Diving into the problem</h1>
<p>Starting the game I was prompted with the message <code>Please insert the Spider-Man CD-ROM, select OK, and restart the game.</code>. Not bad, time to xref on IDA.</p>
<p><img src="../static/images/spidey/cdrom_xref.png" alt="xref of the string" /></p>
<p>What the..? Why there's two of them? The WinMain has you can already guess is the one that prompts when I start the game. The other is from the window handler function.</p>
<p><img src="../static/images/spidey/graph_cdrom_handler.png" alt="graph window handler" /></p>
<p>As you can see IDA could understand that all of those locs are part of a jumptable which indicates me it's <code>switch</code> case and almost all of them lead to <code>DefWindowProcA</code>. If you have done any WinAPI programming you'd know that you call that when you don't want any special handling of certain window interactions and let the OS do it for you.</p>
<p>But which kind of message would make it prompt that message? I left it for now.</p>
<h1>Disabling first CD-ROM protection</h1>
<p><img src="../static/images/spidey/first_cdrom_protection.png" alt="graph winmain" /></p>
<p>Whatever the function is doing it must return 0. My approach to this problem was to simply <code>NOP</code> the function call and turn the <code>jz</code> to a <code>jmp</code>. It worked! The game started, I pressed <code>New Game</code> and... black screen, I start to see my desktop and game closes. What the hell was that?</p>
<p>Couple more tries later I find it actually is showing a message box, somewhere in the code it was sending the message code to show that box.</p>
<h1>Disabling the second CD-ROM protection</h1>
<p>Not knowing what was sending the message I decided to xref the function that I nop'd earlier(let's call it <code>CheckCD</code>) and it was indeed called somewhere else on the program. </p>
<div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">sub_515D80</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">	</span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="c1">// eax</span>
<span class="w">	</span><span class="kt">signed</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">v1</span><span class="p">;</span><span class="w"> </span><span class="c1">// ecx</span>
<span class="w">	</span><span class="kt">signed</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">v2</span><span class="p">;</span><span class="w"> </span><span class="c1">// edx</span>
<span class="w">	</span><span class="n">BOOL</span><span class="w"> </span><span class="n">v3</span><span class="p">;</span><span class="w"> </span><span class="c1">// eax</span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">tagMSG</span><span class="w"> </span><span class="n">Msg</span><span class="p">;</span><span class="w"> </span><span class="c1">// [esp+0h] [ebp-1Ch]</span>

<span class="w">	</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckCD</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">// &lt;-- checks for CD here</span>
<span class="w">	</span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">	</span><span class="c1">//Useless loop to clog the assembly</span>
<span class="w">	</span><span class="k">do</span>
<span class="w">	</span><span class="p">{</span>
<span class="w">		</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">;</span>
<span class="w">		</span><span class="n">v1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="p">);</span>

<span class="w">	</span><span class="c1">//if-of-death</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">_BYTE</span><span class="p">)</span><span class="n">result</span><span class="w"> </span><span class="p">)</span>
<span class="w">	</span><span class="p">{</span>
<span class="w">		</span><span class="n">PostMessageA</span><span class="p">(</span><span class="n">hWnd</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10u</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">		</span><span class="n">byte_2E098E8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">		</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PeekMessageA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">hWnd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">		</span><span class="p">{</span>
<span class="w">			</span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetMessageA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">hWnd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">v3</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="p">)</span>
<span class="w">				</span><span class="k">break</span><span class="p">;</span>
<span class="w">			</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">Msg</span><span class="p">.</span><span class="n">message</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">260</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">Msg</span><span class="p">.</span><span class="n">message</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">261</span><span class="w"> </span><span class="p">)</span>
<span class="w">			</span><span class="p">{</span>
<span class="w">				</span><span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Msg</span><span class="p">);</span>
<span class="w">				</span><span class="n">DispatchMessageA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Msg</span><span class="p">);</span>
<span class="w">			</span><span class="p">}</span>
<span class="w">		</span><span class="p">}</span>
<span class="w">		</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">	</span><span class="p">}</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="p">)</span><span class="c1">//Prevents tampering with the loop</span>
<span class="w">		</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>Now we're looking at IDA pseudo, it really helps to understand what's going on. Although it might be unreliable some times it also helps a lot.</p>
<p>Let's discuss what's going on from easier to harder. The loop is used to fill up the assembly view with a bunch of useless instructions so the reverser has an harder time to know what's going on). If someone accidentally deletes messes the loop while patching some instructions <code>v2</code> won't be 28 so it'll leave.</p>
<p>In my opinion it's kinda clever, back then there was no pseudo-code generation so looking at x86 assembly was the only option which would have made this a lot harder.</p>
<p><code>CheckCD</code> again, must return 0 or else it will go on the if statement. The first thing about the if statement is the <code>PostMessageA</code> which sends the message 0x10 to the handler, which is <code>WM_CLOSE</code>. Then it processes the messages to force the closure, if it fails then it calls <code>exit</code>. They really want to make sure the game was closed.</p>
<p>By the way, the <code>260</code> and <code>261</code> are <code>WM_SYSKEY(UP/DOWN)</code> messages, the game is filtering them so the game wouldn't hang if someone as smashing the keyboard.</p>
<h1>CheckCD exploration</h1>
<p><img src="../static/images/spidey/cdcheck_graph.png" alt="cdrom check" /></p>
<p>As you can see there's a call to <code>sub_516250</code> which does something with <code>texture.dat</code>. What does it do? No idea, it opens it, gets its size, reads the contents and performs some wonky stuff with it. If any of those tasks fails then it returns 0 which makes <code>CheckCD</code> return 2, else it will return a position of the texture.dat buffer.</p>
<p><img src="../static/images/spidey/cdcheck_graph2.png" alt="cdrom check" /></p>
<p>There's some string copy and finally <code>sub_516470</code> is called and the result negated and AND'd with 3, which is not a problem since the negation of zero is still zero and 3 AND 0 is still 0.</p>
<p>To end this I'll post some pseudo to make it less boring.</p>
<div class="highlight"><pre><span></span><span class="kt">signed</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="kr">__cdecl</span><span class="w"> </span><span class="n">sub_516470</span><span class="p">(</span><span class="n">_DWORD</span><span class="w"> </span><span class="o">*</span><span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>

<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">a1</span><span class="w"> </span><span class="p">)</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="mh">0x124</span><span class="p">;</span>
<span class="w">	</span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">	</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindWindowA</span><span class="p">(</span><span class="n">ClassName</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FindWindowA</span><span class="p">(</span><span class="n">ClassName</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">	</span><span class="p">{</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">)</span>
<span class="w">		</span><span class="k">break</span><span class="p">;</span>
<span class="w">		</span><span class="n">SendMessageA</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10u</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">		</span><span class="o">++</span><span class="n">v2</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="n">v19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">	</span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span>
<span class="w">	</span><span class="p">{</span>
<span class="w">		</span><span class="n">RootPathName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">;</span>
<span class="w">		</span><span class="n">v32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">58</span><span class="p">;</span>
<span class="w">		</span><span class="n">v33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">92</span><span class="p">;</span>
<span class="w">		</span><span class="n">v34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">GetDriveTypeA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RootPathName</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">)</span>
<span class="w">		</span><span class="p">{</span>
<span class="w">			</span><span class="c1">//Lots of mciSendCommandA</span>
<span class="w">			</span><span class="c1">//breaks somewhere</span>
<span class="w">		</span><span class="p">}</span>
<span class="w">		</span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__OFSUB__</span><span class="p">(</span><span class="n">v19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">);</span>
<span class="w">		</span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v19</span><span class="o">++</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">v13</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">v14</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">			</span><span class="k">return</span><span class="w"> </span><span class="mi">351</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>A lot has been cleared and altered so it's easier to understand. First it searches for <code>ClassName</code> windows which are <code>SJE_CdPlayerClass</code>. I'm not sure what they are but I think it's the one from the CD-ROM. You can start the game from there so I guess it makes sense to close them if someone goes into a level. Also it just closes until the 100 window.</p>
<p>After that it searches for CD-ROM drives starting on A. If does find the drive then the thing read from texture.dat is compared with something from the disc, I'm not really sure since I didn't care too much about mci commands, my best bet is that it's checking if the thing read from <code>texture.dat</code> is the same, if it does it breaks and returns 0! Else it returns 351. As before with some bytepatching you can ignore the if statement and always return 0.</p>
<p>Those final weird lines are just IDA Pro &quot;&quot;&quot;&quot;failed&quot;&quot;&quot;&quot; decompilation, I put a lot of quotes since it's correct but the decompiler wasn't able to understand the logic in way to simplify it.</p>
<div class="highlight"><pre><span></span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__OFSUB__</span><span class="p">(</span><span class="n">v19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">26</span><span class="p">);</span>
<span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v19</span><span class="o">++</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">v13</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">v14</span><span class="p">)</span><span class="w"> </span><span class="p">)</span>
<span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="mi">351</span><span class="p">;</span>

<span class="n">Comes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">here</span>

<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mf">005166F</span><span class="mi">1</span><span class="w">                 </span><span class="n">mov</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">VARIABLE</span><span class="p">]</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mf">005166F</span><span class="mi">5</span><span class="w">                 </span><span class="n">inc</span><span class="w">     </span><span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mf">005166F</span><span class="mi">6</span><span class="w">                 </span><span class="n">cmp</span><span class="w">     </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="n">Ah</span><span class="p">;</span><span class="w"> </span><span class="mi">26</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mf">005166F</span><span class="mi">9</span><span class="w">                 </span><span class="n">mov</span><span class="w">     </span><span class="p">[</span><span class="n">VARIABLE</span><span class="p">],</span><span class="w"> </span><span class="n">eax</span>
<span class="p">.</span><span class="n">text</span><span class="o">:</span><span class="mf">005166F</span><span class="n">D</span><span class="w">                 </span><span class="n">jl</span><span class="w">      </span><span class="n">loc_5164D1</span>
</pre></div>
<p>Concluding, the  loop instead of <code>while(1)</code> should be <code>while(v19 &lt; 26)</code> because otherwise it would go beyond the letter Z, the last letter of the alphabet. And that's why pseudocode should always be taken as a grain of salt.</p>

	</div>


		</main>

		<footer class="container">
			© 2023 krystalgamer
		</footer>
	</body>

</html>